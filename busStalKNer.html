<!DOCTYPE html>
<html>
  <head>
    <title>BusStalKNer</title>
    <link rel="stylesheet" href="leaflet/leaflet.css"/>
    <style type="text/css">
      #map {
        height: 1000px;
        width: 1000px;
      }
    </style>
    <script src="leaflet/leaflet-src.js"></script>
    <script src="leaflet/leaflet-omnivore.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="leaflet/movingmarker.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <div id="watch"></div>
     <script>
        var zoomLevel = 15;

        function initMap() {
          var map = L.map('map').setView([47.660496, 9.173579], zoomLevel);
          mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

          var mapLayer = L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
            });

          map.addLayer(mapLayer);
          return map;
        }

        function loadFahrplan(url) {
          var json = null;
          $.ajax({
              'async': false,
              'global': false,
              'url': url,
              'dataType': "json",
              'success': function (data) {
                  json = data;
              }
          });
          return json;
        }

        function getLinie(fahrplan, linienName) {
          return fahrplan.find(function(linie) {
            return linie.name == linienName;
          });
        }

        function getClosestStartStation(departures, hour, min) {
          var referenceTime = moment().hours(hour).minutes(min).seconds(0);
          var closest = departures.reduce(function(prev, curr) {
            var prevTime = moment().hours(prev.time.hour).minutes(prev.time.min).seconds(0);
            var currTime = moment().hours(curr.time.hour).minutes(curr.time.min).seconds(0);
            return (Math.abs(currTime.millisecond() - referenceTime.millisecond()) < Math.abs(prevTime.millisecond() - referenceTime.millisecond()) ? curr : prev);
          },departures[0]);
          return closest;
        }

        function getLinienLayer(buslinienLayer, startStationName) {
          var layers = buslinienLayer.getLayers();
          if(layers.length == 0) {
            return;
          }

          var feature = layers.filter(function(layer){
              return layer.feature.properties.StartLang == startStationName;
          });
          return feature;
        }

        function getStationsPassedDuring(stationen, hour) {
          return stationen.filter(function(station) {
            return station.zeiten.hour == hour;
          });
        }

        function addPopupToLayer(layer) {
          layer.on('mouseover', function(e){
            var text = "<ul>";   
            text = text + "<li>StartKurz: " + e.layer.feature.properties["StartKurz"] + "</li>";
            text = text + "<li>ZielKurz: " + e.layer.feature.properties["ZielKurz"] + "</li>";
            text = text + "</ul>";

            if (map) {
               layerPopup = L.popup()
                   .setLatLng(e.latlng)
                   .setContent(text)
                    .openOn(map);
            }

          });

          buslinienLayer.on('mouseout', function (e) {
            if (layerPopup && map) {
                map.closePopup(layerPopup);
                layerPopup = null;
            }
          });
        }

        var map = initMap();
        
        var buslinienLayer = omnivore.kml('/data/Buslinie_WGS84.kml')
        buslinienLayer.addTo(map);
        addPopupToLayer(buslinienLayer);

        var fahrplan = loadFahrplan("data/fahrplan.json");

        window.setInterval(function(){

          if(buslinienLayer.getLayers().length == 0) {
            console.log("layers not loaded.");
            return;
          }

          var hour = 5;
          var min = 1;
          var sec = 30;

          var linie = getLinie(fahrplan.linien, "B1");
          var startStation = getClosestStartStation(linie.departures, hour, min);
          
          var linienLayer = getLinienLayer(buslinienLayer, startStation.name);
          var myMovingMarker = L.Marker.movingMarker(linienLayer[0].getLatLngs(), [1000], {autostart:true}).on('add', function(e) {
            map.setView(e.sourceTarget.getLatLng(), zoomLevel);
          }).addTo(map);
          myMovingMarker.start();
        
        }, 1000);

        


        // var bushaltestellenLayer = omnivore.kml('/data/Bushaltestelle.kml').addTo(map);        

        

    </script>
  </body>



</html>
